<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>App Georreferenciacion SAP - PVCACH</title>
    <meta name="theme-color" content="#4A90E2">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Librería para exportar a Excel (SheetJS) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Librería para conversión de coordenadas a UTM (Proj4JS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>

    <style>
        #map { height: 50vh; width: 100%; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        body { touch-action: none; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 8px;
            width: 90%; max-width: 400px;
        }
        .leaflet-marker-icon.selected {
            filter: hue-rotate(120deg) brightness(1.5);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans flex flex-col h-screen">

    <!-- Modal para pedir nombres -->
    <div id="name-modal" class="modal-overlay hidden">
        <div class="modal-content dark:bg-gray-800 shadow-xl rounded-lg">
            <h3 id="modal-title" class="text-lg font-bold mb-4"></h3>
            <input type="text" id="modal-input" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 mb-4">
            <div class="flex justify-end space-x-2">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded">Cancelar</button>
                <button id="modal-ok" class="px-4 py-2 bg-blue-600 text-white rounded">Aceptar</button>
            </div>
        </div>
    </div>

    <main class="flex-grow flex flex-col p-4 space-y-4">
        <div id="map" class="bg-gray-300"></div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 text-center">
                <button id="add-marker-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform active:scale-95">
                    Agregar Ubicación
                </button>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 text-center">
                 <button id="connection-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform active:scale-95">
                    Crear Conexión
                </button>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 text-center">
                 <button id="export-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform active:scale-95">
                    Exportar a Excel
                </button>
            </div>
        </div>
        
        <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-4 overflow-y-auto pb-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 flex flex-col">
                <h2 class="text-xl font-bold mb-2 text-center">Puntos Guardados</h2>
                <ul id="points-list" class="space-y-2 overflow-y-auto">
                    <li id="no-points-msg" class="text-gray-500 text-center">Aún no has guardado ningún punto.</li>
                </ul>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 flex flex-col">
                <h2 class="text-xl font-bold mb-2 text-center">Conexiones</h2>
                <ul id="connections-list" class="space-y-2 overflow-y-auto">
                    <li id="no-connections-msg" class="text-gray-500 text-center">No hay conexiones guardadas.</li>
                </ul>
            </div>
        </div>
    </main>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- IndexedDB Helper -->
    <script src="indexedDB.js"></script>

    <script>
        // --- FUNCIÓN GLOBAL PARA MANEJAR CLIC EN "VER" ---
        function viewPointOnMap(id, lat, lon) {
            window.myApp.viewPoint(id, lat, lon);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            window.myApp = {}; // Namespace para la app

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').then(reg => console.log('Service Worker registrado', reg)).catch(err => console.error('Error al registrar SW', err));
            }

            await initDB();
            const map = L.map('map').setView([-13.5226, -71.9673], 13);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri'
            }).addTo(map);

            const markersLayer = L.layerGroup().addTo(map);
            const connectionsLayer = L.layerGroup().addTo(map);
            let leafletMarkers = {};
            
            let isConnecting = false;
            let selectedPointsForConnection = [];

            const addMarkerBtn = document.getElementById('add-marker-btn');
            const connectionBtn = document.getElementById('connection-btn');
            const exportBtn = document.getElementById('export-btn');
            const pointsList = document.getElementById('points-list');
            const connectionsList = document.getElementById('connections-list');
            const noPointsMsg = document.getElementById('no-points-msg');
            const noConnectionsMsg = document.getElementById('no-connections-msg');
            
            const modal = document.getElementById('name-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalInput = document.getElementById('modal-input');
            const modalOk = document.getElementById('modal-ok');
            const modalCancel = document.getElementById('modal-cancel');
            let modalResolve = null;

            function askForName(title, placeholder = '') {
                modalTitle.textContent = title;
                modalInput.value = '';
                modalInput.placeholder = placeholder;
                modal.classList.remove('hidden');
                modalInput.focus();
                return new Promise(resolve => { modalResolve = resolve; });
            }
            modalOk.addEventListener('click', () => {
                if (modalResolve) modalResolve(modalInput.value);
                modal.classList.add('hidden');
                modalResolve = null;
            });
            modalCancel.addEventListener('click', () => {
                if (modalResolve) modalResolve(null);
                modal.classList.add('hidden');
                modalResolve = null;
            });

            async function renderAll() {
                await renderPoints();
                await renderConnections();
            }

            async function renderPoints() {
                markersLayer.clearLayers();
                leafletMarkers = {};
                pointsList.innerHTML = '';
                const points = await getPoints();

                if (points.length === 0) {
                    pointsList.appendChild(noPointsMsg);
                    noPointsMsg.style.display = 'block';
                } else {
                    noPointsMsg.style.display = 'none';
                    points.forEach(point => {
                        const marker = L.marker([point.lat, point.lon]).addTo(markersLayer);
                        leafletMarkers[point.id] = marker;

                        const popupContent = `
                            <div class="text-base">
                                <strong class="point-name">${point.name || 'Punto #' + point.id}</strong>
                                <p class="text-sm text-gray-500">Lat: ${point.lat.toFixed(5)}, Lon: ${point.lon.toFixed(5)}</p>
                                <div class="mt-2 flex space-x-2">
                                    <button class="edit-btn text-blue-500" data-id="${point.id}">Editar Nombre</button>
                                    <button class="delete-btn text-red-500" data-id="${point.id}">Eliminar</button>
                                </div>
                            </div>`;
                        marker.bindPopup(popupContent);
                        
                        const li = document.createElement('li');
                        li.className = 'bg-gray-200 dark:bg-gray-700 p-2 rounded flex justify-between items-center';
                        li.innerHTML = `<span>${point.name || `Punto #${point.id}`}</span> <button class="text-xs text-blue-500 font-semibold" onclick="viewPointOnMap(${point.id}, ${point.lat}, ${point.lon})">Ver</button>`;
                        pointsList.appendChild(li);

                        marker.on('click', () => {
                            if (isConnecting) {
                                togglePointSelection(point);
                            }
                        });
                    });
                }
            }
            
            window.myApp.viewPoint = (id, lat, lon) => {
                map.setView([lat, lon], 18);
                const marker = leafletMarkers[id];
                if (marker) {
                    marker.openPopup();
                }
            };

            async function renderConnections() {
                connectionsLayer.clearLayers();
                connectionsList.innerHTML = '';
                const connections = await getConnections();
                const points = await getPoints();

                if (connections.length === 0) {
                    connectionsList.appendChild(noConnectionsMsg);
                    noConnectionsMsg.style.display = 'block';
                } else {
                    noConnectionsMsg.style.display = 'none';
                    connections.forEach(conn => {
                        const latlngs = conn.pointIds
                            .map(id => points.find(p => p.id === id))
                            .filter(p => p)
                            .map(p => [p.lat, p.lon]);
                        
                        if (latlngs.length > 1) {
                            L.polyline(latlngs, { color: 'orange' }).addTo(connectionsLayer);
                        }

                        const li = document.createElement('li');
                        li.className = 'bg-gray-200 dark:bg-gray-700 p-2 rounded flex justify-between items-center';
                        li.innerHTML = `<span>${conn.name}</span> <button class="delete-conn-btn text-xs text-red-500" data-id="${conn.id}">X</button>`;
                        connectionsList.appendChild(li);
                    });
                }
            }
            
            document.addEventListener('click', async (e) => {
                if (e.target.matches('.edit-btn')) {
                    const pointId = Number(e.target.dataset.id);
                    const newName = await askForName('Editar nombre del punto', 'Nuevo nombre');
                    if (newName !== null) {
                        await updatePoint(pointId, { name: newName });
                        map.closePopup();
                        await renderAll();
                    }
                }
                if (e.target.matches('.delete-btn')) {
                    const pointId = Number(e.target.dataset.id);
                    if (confirm('¿Seguro que quieres eliminar este punto?')) {
                        await deletePoint(pointId);
                        map.closePopup();
                        await renderAll();
                    }
                }
                if (e.target.matches('.delete-conn-btn')) {
                    const connId = Number(e.target.dataset.id);
                    if (confirm('¿Seguro que quieres eliminar esta conexión?')) {
                        await deleteConnection(connId);
                        await renderAll();
                    }
                }
            });

            addMarkerBtn.addEventListener('click', () => {
                addMarkerBtn.textContent = 'Obteniendo...';
                addMarkerBtn.disabled = true;
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const { latitude, longitude } = position.coords;
                        const pointId = await savePoint({ lat: latitude, lon: longitude });
                        const newName = await askForName('Nombre del nuevo punto', `Punto #${pointId}`);
                        if (newName) {
                            await updatePoint(pointId, { name: newName });
                        }
                        await renderAll();
                        map.setView([latitude, longitude], 18);
                        addMarkerBtn.textContent = 'Agregar Ubicación';
                        addMarkerBtn.disabled = false;
                    },
                    (error) => {
                        alert(`Error al obtener ubicación: ${error.message}`);
                        addMarkerBtn.textContent = 'Agregar Ubicación';
                        addMarkerBtn.disabled = false;
                    }, { enableHighAccuracy: true }
                );
            });
            
            connectionBtn.addEventListener('click', async () => {
                isConnecting = !isConnecting;
                if (isConnecting) {
                    connectionBtn.textContent = 'Finalizar Conexión (0)';
                    connectionBtn.classList.replace('bg-green-600', 'bg-yellow-500');
                    connectionBtn.classList.replace('hover:bg-green-700', 'hover:bg-yellow-600');
                    selectedPointsForConnection = [];
                    alert('Modo Conexión: Haz clic en los marcadores del mapa para unirlos.');
                } else {
                    if (selectedPointsForConnection.length >= 2) {
                        const connName = await askForName('Nombre de la Conexión', 'Mi Ruta');
                        if (connName) {
                            const pointIds = selectedPointsForConnection.map(p => p.id);
                            await saveConnection({ name: connName, pointIds: pointIds });
                        }
                    } else {
                         alert('Necesitas seleccionar al menos 2 puntos.');
                    }
                    resetConnectionState();
                    await renderAll();
                }
            });

            function togglePointSelection(point) {
                const marker = leafletMarkers[point.id];
                const index = selectedPointsForConnection.findIndex(p => p.id === point.id);

                if (index > -1) {
                    selectedPointsForConnection.splice(index, 1);
                    marker.getElement().classList.remove('selected');
                } else {
                    selectedPointsForConnection.push(point);
                    marker.getElement().classList.add('selected');
                }
                connectionBtn.textContent = `Finalizar Conexión (${selectedPointsForConnection.length})`;
            }

            function resetConnectionState() {
                isConnecting = false;
                connectionBtn.textContent = 'Crear Conexión';
                connectionBtn.classList.replace('bg-yellow-500', 'bg-green-600');
                connectionBtn.classList.replace('hover:bg-yellow-600', 'hover:bg-green-700');
                selectedPointsForConnection = [];
                Object.values(leafletMarkers).forEach(m => m.getElement()?.classList.remove('selected'));
            }
            
            // --- FUNCIÓN HELPER PARA LA LETRA DE ZONA UTM ---
            function getUtmLetterDesignator(latitude) {
                if (-80 <= latitude && latitude <= 84) {
                    // Letras C..X, omitiendo I y O
                    return "CDEFGHJKLMNPQRSTUVWXX".charAt(Math.floor((latitude + 80) / 8));
                }
                return 'Z'; // Fuera de rango
            }

            // --- LÓGICA PARA EXPORTAR A EXCEL (ACTUALIZADA A Proj4JS) ---
            exportBtn.addEventListener('click', async () => {
                exportBtn.textContent = 'Exportando...';
                exportBtn.disabled = true;

                if (typeof XLSX === 'undefined' || typeof proj4 === 'undefined') {
                    alert('Las librerías para exportar no se han cargado. Revisa tu conexión a internet e inténtalo de nuevo.');
                    exportBtn.textContent = 'Exportar a Excel';
                    exportBtn.disabled = false;
                    return;
                }

                try {
                    const points = await getPoints();
                    const connections = await getConnections();

                    const componentesData = [
                        ['ID Punto', 'Puntos Guardados', 'Zona', 'Este', 'Norte', 'Latitud', 'Longitud']
                    ];
                    
                    const wgs84Def = '+proj=longlat +datum=WGS84 +no_defs';

                    points.forEach(p => {
                        const lon = p.lon;
                        const lat = p.lat;
                        const zone = Math.floor((lon + 180) / 6) + 1;
                        const utmDef = `+proj=utm +zone=${zone} ${lat < 0 ? '+south' : ''} +datum=WGS84 +units=m +no_defs`;
                        const utmCoords = proj4(wgs84Def, utmDef, [lon, lat]);
                        const zoneLetter = getUtmLetterDesignator(lat);

                        componentesData.push([
                            p.id,
                            p.name || `Punto #${p.id}`,
                            `${zone}${zoneLetter}`,
                            utmCoords[0].toFixed(2),
                            utmCoords[1].toFixed(2),
                            p.lat,
                            p.lon
                        ]);
                    });

                    const conexionesData = [
                        ['ID Origen', 'ID Destino', 'Nombre Conexión']
                    ];
                    connections.forEach(conn => {
                        for (let i = 0; i < conn.pointIds.length - 1; i++) {
                            conexionesData.push([
                                conn.pointIds[i],
                                conn.pointIds[i+1],
                                conn.name
                            ]);
                        }
                    });

                    const wb = XLSX.utils.book_new();
                    const wsComponentes = XLSX.utils.aoa_to_sheet(componentesData);
                    const wsConexiones = XLSX.utils.aoa_to_sheet(conexionesData);

                    XLSX.utils.book_append_sheet(wb, wsComponentes, 'Componentes');
                    XLSX.utils.book_append_sheet(wb, wsConexiones, 'Conexiones');

                    XLSX.writeFile(wb, 'GeoSAP_reporte.xlsx');

                } catch (error) {
                    console.error("Error al exportar a Excel:", error);
                    alert("Hubo un error al generar el archivo de Excel. Verifique la consola para más detalles.");
                } finally {
                    exportBtn.textContent = 'Exportar a Excel';
                    exportBtn.disabled = false;
                }
            });

            await renderAll();
        });
    </script>
</body>
</html>
