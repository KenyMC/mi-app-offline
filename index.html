<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>App Georreferenciacion SAP - PVCACH</title>
    <meta name="theme-color" content="#4A90E2">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Librería para exportar a Excel (SheetJS) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Librería para conversión de coordenadas a UTM (Proj4JS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>

    <style>
        #map { height: 50vh; width: 100%; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        body { touch-action: none; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 8px;
            width: 90%; max-width: 400px;
        }
        .leaflet-marker-icon.selected-origin {
            filter: hue-rotate(240deg) brightness(1.5); /* Azul brillante */
        }
        .leaflet-marker-icon.selected-destination {
            filter: hue-rotate(120deg) brightness(1.5); /* Verde brillante */
        }
        /* Estilos para las etiquetas en el mapa */
        .map-label {
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: bold;
            box-shadow: none;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans flex flex-col h-screen">

    <!-- Modal para pedir nombres -->
    <div id="name-modal" class="modal-overlay hidden">
        <div class="modal-content dark:bg-gray-800 shadow-xl rounded-lg">
            <h3 id="modal-title" class="text-lg font-bold mb-4"></h3>
            <input type="text" id="modal-input" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 mb-4">
            <div class="flex justify-end space-x-2">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded">Cancelar</button>
                <button id="modal-ok" class="px-4 py-2 bg-blue-600 text-white rounded">Aceptar</button>
            </div>
        </div>
    </div>

    <main class="flex-grow flex flex-col p-4 space-y-4">
        
        <div id="top-section" class="text-center">
            <!-- INDICADOR DE ESTADO DE CONEXIÓN -->
            <div id="status-indicator" class="text-xs p-2 rounded-lg font-bold inline-block"></div>
            <!-- MENSAJE DE AYUDA PARA MODO OFFLINE -->
            <p id="offline-map-tip" class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                <b>Tip:</b> Para usar el mapa sin conexión, navega por tu posible ruta de trabajo mientras tengas internet. La app guardará esa área.
            </p>
        </div>

        <div id="map" class="bg-gray-300"></div>

        <!-- SECCIÓN DE BOTONES MEJORADA -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
            <button id="add-marker-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform active:scale-95 text-sm">
                Agregar Ubicación
            </button>
            <button id="connection-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform active:scale-95 text-sm">
                Crear Conexión
            </button>
            <button id="export-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform active:scale-95 text-sm">
                Exportar Excel
            </button>
            <div class="flex items-center justify-center gap-1">
                <button id="clear-map-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform active:scale-95 text-sm">
                    Limpiar Mapa
                </button>
                <a href="#lists-section" id="scroll-down-btn" class="p-2 text-center bg-gray-600 hover:bg-gray-700 rounded-lg transition-transform transform active:scale-95">
                    <svg class="w-4 h-4 text-white mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    <span class="text-white text-xs">Bajar</span>
                </a>
            </div>
        </div>
        
        <!-- SECCIÓN DE LISTAS CON ID PARA EL SCROLL -->
        <div id="lists-section" class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-4 overflow-y-auto pb-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 flex flex-col">
                <h2 class="text-xl font-bold mb-2 text-center">Puntos Guardados</h2>
                <ul id="points-list" class="space-y-2 overflow-y-auto">
                    <li id="no-points-msg" class="text-gray-500 text-center">Aún no has guardado ningún punto.</li>
                </ul>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 flex flex-col">
                <h2 class="text-xl font-bold mb-2 text-center">Conexiones</h2>
                <ul id="connections-list" class="space-y-2 overflow-y-auto">
                    <li id="no-connections-msg" class="text-gray-500 text-center">No hay conexiones guardadas.</li>
                </ul>
            </div>
        </div>
        
        <!-- BOTÓN PARA SUBIR (NUEVA UBICACIÓN) -->
        <div class="flex justify-end mt-2">
            <a href="#top-section" id="scroll-up-btn" class="p-2 text-center bg-gray-600 hover:bg-gray-700 rounded-lg transition-transform transform active:scale-95 inline-flex flex-col items-center">
                <svg class="w-5 h-5 text-white mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                <span class="text-white text-xs">Subir</span>
            </a>
        </div>
    </main>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- IndexedDB Helper -->
    <script src="indexedDB.js"></script>

    <script>
        function viewPointOnMap(id) {
            window.myApp.viewPoint(id);
        }
        function viewConnectionOnMap(id) {
            window.myApp.viewConnection(id);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            window.myApp = {}; 

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').then(reg => console.log('Service Worker registrado', reg)).catch(err => console.error('Error al registrar SW', err));
            }

            await initDB();
            const map = L.map('map').setView([-13.5226, -71.9673], 13);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri'
            }).addTo(map);

            const markersLayer = L.layerGroup().addTo(map);
            const connectionsLayer = L.layerGroup().addTo(map);
            let leafletMarkers = {};
            let leafletConnections = {};
            
            let connectionState = 'idle';
            let connectionPoints = [];

            const addMarkerBtn = document.getElementById('add-marker-btn');
            const connectionBtn = document.getElementById('connection-btn');
            const exportBtn = document.getElementById('export-btn');
            const clearMapBtn = document.getElementById('clear-map-btn');
            const scrollDownBtn = document.getElementById('scroll-down-btn');
            const scrollUpBtn = document.getElementById('scroll-up-btn');
            const pointsList = document.getElementById('points-list');
            const connectionsList = document.getElementById('connections-list');
            const noPointsMsg = document.getElementById('no-points-msg');
            const noConnectionsMsg = document.getElementById('no-connections-msg');
            const statusIndicator = document.getElementById('status-indicator');
            const offlineTip = document.getElementById('offline-map-tip');
            
            const modal = document.getElementById('name-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalInput = document.getElementById('modal-input');
            const modalOk = document.getElementById('modal-ok');
            const modalCancel = document.getElementById('modal-cancel');
            let modalResolve = null;

            function updateOnlineStatus() {
                if (navigator.onLine) {
                    statusIndicator.textContent = 'Estado: Conectado';
                    statusIndicator.className = 'text-xs p-2 rounded-lg font-bold inline-block bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300';
                    offlineTip.style.display = 'block';
                } else {
                    statusIndicator.textContent = 'Estado: Sin Conexión (Modo Offline)';
                    statusIndicator.className = 'text-xs p-2 rounded-lg font-bold inline-block bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300';
                    offlineTip.style.display = 'none';
                }
            }
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();

            function askForName(title, placeholder = '') {
                modalTitle.textContent = title;
                modalInput.value = '';
                modalInput.placeholder = placeholder;
                modal.classList.remove('hidden');
                modalInput.focus();
                return new Promise(resolve => { modalResolve = resolve; });
            }
            modalOk.addEventListener('click', () => {
                if (modalResolve) modalResolve(modalInput.value);
                modal.classList.add('hidden');
                modalResolve = null;
            });
            modalCancel.addEventListener('click', () => {
                if (modalResolve) modalResolve(null);
                modal.classList.add('hidden');
                modalResolve = null;
            });

            async function renderAll() {
                await renderPoints();
                await renderConnections();
            }

            async function renderPoints() {
                markersLayer.clearLayers();
                leafletMarkers = {};
                pointsList.innerHTML = '';
                const points = await getPoints();

                if (points.length === 0) {
                    pointsList.appendChild(noPointsMsg);
                    noPointsMsg.style.display = 'block';
                } else {
                    noPointsMsg.style.display = 'none';
                    points.forEach(point => {
                        const marker = L.marker([point.lat, point.lon]).addTo(markersLayer);
                        leafletMarkers[point.id] = marker;

                        const popupContent = `<div class="text-base"><strong class="point-name">${point.name || 'Punto #' + point.id}</strong><p class="text-sm text-gray-500">Lat: ${point.lat.toFixed(5)}, Lon: ${point.lon.toFixed(5)}</p><div class="mt-2 flex space-x-2"><button class="edit-btn text-blue-500" data-id="${point.id}">Editar</button><button class="delete-btn text-red-500" data-id="${point.id}">Eliminar</button></div></div>`;
                        marker.bindPopup(popupContent);
                        
                        marker.bindTooltip(point.name || `Punto #${point.id}`, { permanent: true, className: 'map-label', offset: [0, -15] });

                        const li = document.createElement('li');
                        li.className = 'bg-gray-200 dark:bg-gray-700 p-2 rounded flex justify-between items-center';
                        li.innerHTML = `<span>${point.name || `Punto #${point.id}`}</span> <button class="text-xs text-blue-500 font-semibold" onclick="viewPointOnMap(${point.id})">Ver</button>`;
                        pointsList.appendChild(li);

                        marker.on('click', () => handleMarkerClick(point));
                    });
                }
            }
            
            window.myApp.viewPoint = (id) => {
                const marker = leafletMarkers[id];
                if (marker) {
                    map.setView(marker.getLatLng(), 18);
                    marker.openPopup();
                }
            };
            
            window.myApp.viewConnection = (id) => {
                const polyline = leafletConnections[id];
                if(polyline) {
                    map.fitBounds(polyline.getBounds().pad(0.1)); // pad(0.1) da un poco de margen
                    polyline.openPopup();
                }
            };

            async function renderConnections() {
                connectionsLayer.clearLayers();
                leafletConnections = {};
                connectionsList.innerHTML = '';
                const connections = await getConnections();
                const points = await getPoints();

                if (connections.length === 0) {
                    connectionsList.appendChild(noConnectionsMsg);
                    noConnectionsMsg.style.display = 'block';
                } else {
                    noConnectionsMsg.style.display = 'none';
                    connections.forEach(conn => {
                        const latlngs = conn.pointIds.map(id => points.find(p => p.id === id)).filter(p => p).map(p => [p.lat, p.lon]);
                        
                        if (latlngs.length > 1) {
                            const polyline = L.polyline(latlngs, { color: 'orange' }).addTo(connectionsLayer);
                            leafletConnections[conn.id] = polyline;

                            const popupContent = `<div class="text-base"><strong>${conn.name}</strong><div class="mt-2 flex space-x-2"><button class="edit-conn-btn text-blue-500" data-id="${conn.id}">Editar</button><button class="delete-conn-btn text-red-500" data-id="${conn.id}">Eliminar</button></div></div>`;
                            polyline.bindPopup(popupContent);
                            
                            const center = polyline.getCenter();
                            L.tooltip({ permanent: true, direction: 'center', className: 'map-label' }).setLatLng(center).setContent(conn.name).addTo(connectionsLayer);

                            const li = document.createElement('li');
                            li.className = 'bg-gray-200 dark:bg-gray-700 p-2 rounded flex justify-between items-center';
                            li.innerHTML = `<span>${conn.name}</span> <button class="text-xs text-blue-500 font-semibold" onclick="viewConnectionOnMap(${conn.id})">Ver</button>`;
                            connectionsList.appendChild(li);
                        }
                    });
                }
            }
            
            document.addEventListener('click', async (e) => {
                if (e.target.matches('.edit-btn')) {
                    const pointId = Number(e.target.dataset.id);
                    const newName = await askForName('Editar nombre del punto', 'Nuevo nombre');
                    if (newName !== null) {
                        await updatePoint(pointId, { name: newName });
                        map.closePopup();
                        await renderAll();
                    }
                }
                if (e.target.matches('.delete-btn')) {
                    const pointId = Number(e.target.dataset.id);
                    if (confirm('¿Seguro que quieres eliminar este punto?')) {
                        await deletePoint(pointId);
                        map.closePopup();
                        await renderAll();
                    }
                }
                if (e.target.matches('.edit-conn-btn')) {
                    const connId = Number(e.target.dataset.id);
                    const newName = await askForName('Editar nombre de la conexión', 'Nuevo nombre');
                    if (newName !== null) {
                        await updateConnection(connId, { name: newName });
                        map.closePopup();
                        await renderAll();
                    }
                }
                if (e.target.matches('.delete-conn-btn')) {
                    const connId = Number(e.target.dataset.id);
                    if (confirm('¿Seguro que quieres eliminar esta conexión?')) {
                        await deleteConnection(connId);
                        map.closePopup();
                        await renderAll();
                    }
                }
            });

            addMarkerBtn.addEventListener('click', () => {
                addMarkerBtn.textContent = 'Obteniendo...';
                addMarkerBtn.disabled = true;
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const { latitude, longitude } = position.coords;
                        const pointId = await savePoint({ lat: latitude, lon: longitude });
                        const newName = await askForName('Nombre del nuevo punto', `Punto #${pointId}`);
                        if (newName) await updatePoint(pointId, { name: newName });
                        await renderAll();
                        map.setView([latitude, longitude], 18);
                        addMarkerBtn.textContent = 'Agregar Ubicación';
                        addMarkerBtn.disabled = false;
                    },
                    (error) => {
                        alert(`Error al obtener ubicación: ${error.message}`);
                        addMarkerBtn.textContent = 'Agregar Ubicación';
                        addMarkerBtn.disabled = false;
                    }, { enableHighAccuracy: true }
                );
            });
            
            connectionBtn.addEventListener('click', () => {
                if (connectionState === 'idle') {
                    startConnectionProcess();
                } else {
                    resetConnectionState();
                }
            });

            function startConnectionProcess() {
                connectionState = 'picking_origin';
                connectionPoints = [];
                connectionBtn.textContent = 'Cancelar';
                connectionBtn.classList.replace('bg-green-600', 'bg-red-600');
                connectionBtn.classList.replace('hover:bg-green-700', 'hover:bg-red-700');
                alert('Seleccione el PUNTO DE ORIGEN en el mapa.');
            }

            async function handleMarkerClick(point) {
                if (connectionState === 'picking_origin') {
                    connectionPoints.push(point);
                    leafletMarkers[point.id].getElement().classList.add('selected-origin');
                    connectionState = 'picking_destination';
                    alert('Seleccione el PUNTO DE DESTINO en el mapa.');
                } else if (connectionState === 'picking_destination') {
                    if (point.id === connectionPoints[0].id) {
                        alert('No puedes conectar un punto consigo mismo.');
                        return;
                    }
                    connectionPoints.push(point);
                    leafletMarkers[point.id].getElement().classList.add('selected-destination');
                    
                    const connName = await askForName('Nombre de la Conexión', 'Mi Ruta');
                    if (connName) {
                        const pointIds = connectionPoints.map(p => p.id);
                        await saveConnection({ name: connName, pointIds: pointIds });
                    }
                    resetConnectionState();
                    await renderAll();
                }
            }

            function resetConnectionState() {
                connectionState = 'idle';
                connectionPoints = [];
                connectionBtn.textContent = 'Crear Conexión';
                connectionBtn.classList.replace('bg-red-600', 'bg-green-600');
                connectionBtn.classList.replace('hover:bg-red-700', 'hover:bg-green-700');
                Object.values(leafletMarkers).forEach(m => {
                    m.getElement()?.classList.remove('selected-origin', 'selected-destination');
                });
            }
            
            clearMapBtn.addEventListener('click', async () => {
                const confirmed = confirm('Esta acción eliminará todos los puntos y conexiones. ¿Estás seguro?');
                if (confirmed) {
                    try {
                        const points = await getPoints();
                        const connections = await getConnections();
                        const deletePointsPromises = points.map(p => deletePoint(p.id));
                        const deleteConnectionsPromises = connections.map(c => deleteConnection(c.id));
                        await Promise.all([...deletePointsPromises, ...deleteConnectionsPromises]);
                        await renderAll();
                        alert('Todos los datos han sido eliminados.');
                    } catch (error) {
                        console.error('Error al limpiar el mapa:', error);
                        alert('Hubo un error al eliminar los datos.');
                    }
                }
            });

            scrollDownBtn.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('lists-section').scrollIntoView({ behavior: 'smooth' });
            });
            
            scrollUpBtn.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('top-section').scrollIntoView({ behavior: 'smooth' });
            });

            function getUtmLetterDesignator(latitude) {
                if (-80 <= latitude && latitude <= 84) return "CDEFGHJKLMNPQRSTUVWXX".charAt(Math.floor((latitude + 80) / 8));
                return 'Z';
            }

            exportBtn.addEventListener('click', async () => {
                exportBtn.textContent = 'Exportando...';
                exportBtn.disabled = true;

                if (typeof XLSX === 'undefined' || typeof proj4 === 'undefined') {
                    alert('Las librerías para exportar no se han cargado. Revisa tu conexión a internet e inténtalo de nuevo.');
                    exportBtn.textContent = 'Exportar a Excel';
                    exportBtn.disabled = false;
                    return;
                }

                try {
                    const points = await getPoints();
                    const connections = await getConnections();
                    const componentesData = [['ID Punto', 'Puntos Guardados', 'Zona', 'Este', 'Norte', 'Latitud', 'Longitud']];
                    const wgs84Def = '+proj=longlat +datum=WGS84 +no_defs';

                    points.forEach(p => {
                        const lon = p.lon;
                        const lat = p.lat;
                        const zone = Math.floor((lon + 180) / 6) + 1;
                        const utmDef = `+proj=utm +zone=${zone} ${lat < 0 ? '+south' : ''} +datum=WGS84 +units=m +no_defs`;
                        const utmCoords = proj4(wgs84Def, utmDef, [lon, lat]);
                        const zoneLetter = getUtmLetterDesignator(lat);
                        componentesData.push([p.id, p.name || `Punto #${p.id}`, `${zone}${zoneLetter}`, utmCoords[0].toFixed(2), utmCoords[1].toFixed(2), p.lat, p.lon]);
                    });

                    const conexionesData = [['ID Origen', 'ID Destino', 'Nombre Conexión']];
                    connections.forEach(conn => {
                        for (let i = 0; i < conn.pointIds.length - 1; i++) {
                            conexionesData.push([conn.pointIds[i], conn.pointIds[i+1], conn.name]);
                        }
                    });

                    const wb = XLSX.utils.book_new();
                    const wsComponentes = XLSX.utils.aoa_to_sheet(componentesData);
                    const wsConexiones = XLSX.utils.aoa_to_sheet(conexionesData);
                    XLSX.utils.book_append_sheet(wb, wsComponentes, 'Componentes');
                    XLSX.utils.book_append_sheet(wb, wsConexiones, 'Conexiones');
                    XLSX.writeFile(wb, 'GeoSAP_reporte.xlsx');

                } catch (error) {
                    console.error("Error al exportar a Excel:", error);
                    alert("Hubo un error al generar el archivo de Excel. Verifique la consola para más detalles.");
                } finally {
                    exportBtn.textContent = 'Exportar Excel';
                    exportBtn.disabled = false;
                }
            });

            await renderAll();
        });
    </script>
</body>
</html>
